language: node_js

# Version number
node_js:
  - 0.12
  
build:
 # pre_ci:
  #Testing for pre_ci carrying over to pre_ci_boot
  #  - export IMAGE_TAG="latest"
 #   - echo $IMAGE_TAG
    
  pre_ci_boot:
    image_name: shippabledocker/sample_node_pvt
    image_tag: latest.40
    pull: true
    options: '--privileged=true --net=bridge -e FOO=true -e BOO=false' 

  ci:   
    - node --version  
    - docker pull library/busybox:latest
   
  post_ci:
  # Testing docker build and push
    #- docker build -t=$IMAGE_NAME:$IMAGE_TAG .
   # - docker push $IMAGE_NAME:$IMAGE_TAG
  # Testing gcr build and push
   # - docker build -t=gcr.io/vidya-project/node1-img:master.33  .
   # - docker push gcr.io/vidya-project/node1-img:master.33
  # Testing quay build and push
    #- docker build -t=quay.io/revathird/samplenode_test .
    #- docker push quay.io/revathird/samplenode_test
   # Testing ecr build and push
    #- docker build -t=742038439709.dkr.ecr.us-west-2.amazonaws.com/sample_node:latest2 .
    - docker tag library/busybox:latest  742038439709.dkr.ecr.us-west-2.amazonaws.com/sample_node:latest2
    - docker push 742038439709.dkr.ecr.us-west-2.amazonaws.com/sample_node:latest2
   # - docker build -t=742038439709.dkr.ecr.us-east-1.amazonaws.com/sample_php:latest2 .
    - docker tag library/busybox:latest 742038439709.dkr.ecr.us-east-1.amazonaws.com/sample_php:latest2
    - docker push 742038439709.dkr.ecr.us-east-1.amazonaws.com/sample_php:latest2
    
  on_success:
  # Testing to push to s3 bucket
    - aws s3 sync $SHIPPABLE_BUILD_DIR $"s3://push-to-s3" --region $"us-west-2"
  
integrations:
  hub:
    - integrationName: ship-docker
      type: docker 

  #ECR integration
    - integrationName: ship-ecrwest2
      type: ecr
      region: us-west-2
      
    - integrationName: ship-ecreast1
      type: ecr
      region: us-east-1
      
  deploy:
  
    - integrationName: "ship-aws"
      type: aws
      target: eb_paas
      platform: "Node.js"
      application_name: "sample-node-eb-sample-apptest"
      env_name: "Sample-env"
      region: "us-west-2"  
      
    - integrationName: "ship-aws"
      type: aws
      target: eb_docker
      application_name: "sample-node-eb-docker-apptest"
      env_name: "Sample-env-1"
      bucket_name: "elasticbeanstalk-us-east-1-742038439709"
      region: "us-west-2"
      image_name: "shippabledocker/pipelinev2"
      image_tag: "$BRANCH.$BUILD_NUMBER"    
